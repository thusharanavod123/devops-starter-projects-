name: CI - Build Docker Image

# 1. Define when this workflow should run
on:
  push:
    branches:
      - main # Run whenever code is pushed to the 'main' branch

jobs:
  # 2. Define the main build job
  build:
    runs-on: ubuntu-latest # Use a fresh Linux virtual machine provided by GitHub
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4 # Get the latest code from the repository

      # 3. Use the Docker official action to build the image
      # Note: We are only building locally for CI, not pushing to Docker Hub yet.
      - name: Build Docker Image
        uses: docker/build-push-action@v5
        with:
          context: . # Look for the Dockerfile in the current directory
          push: false # Do not push to a registry (only build for testing)
          tags: ${{ github.repository_owner }}/devops-starter-projects:latest, ${{ github.repository_owner }}/devops-starter-projects:${{ github.sha }}
          
      # 4. A better smoke test: Run the container and check if it's serving content
      - name: Run Smoke Test
        run: |
          echo "Running container from the built image..."
          docker run --name my-test-app -d -p 8080:80 ${{ github.repository_owner }}/devops-starter-projects:latest
          echo "Waiting for container to start..."
          sleep 5
          echo "Testing web server response..."
          # Use curl with -f to fail the step on HTTP error codes (like 404 or 500)
          curl -f http://localhost:8080

      # 5. Conceptual output for successful completion
      - name: CI Success Message
        run: |
          echo "==================================================="
          echo "CI Pipeline Successful! Image built on GitHub."
          echo "The image tag would be based on the commit: ${{ github.sha }}"
          echo "==================================================="